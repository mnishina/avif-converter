# AVIF画像変換CLIツール 仕様書

## 1. 概要

PNG/JPEG画像をAVIF形式に一括変換するコマンドラインツール。
Figmaなどのデザインツールから書き出した画像を効率的に変換することを目的とする。

## 2. 主要機能

### 2.1 基本機能
- フォルダ内の画像ファイルを一括でAVIFに変換
- 対応入力形式: PNG, JPEG, JPG, WebP
- 画質設定: 0-100の範囲で指定可能
- 元のファイル名を維持（拡張子のみ.avifに変更）
- 同形式の圧縮版（フォールバック用）を同時生成
- 変換前に出力フォルダを自動リセット

### 2.2 インタラクティブモード
- コマンド実行時に対話形式で設定を入力
- 入力フォルダ、出力フォルダ、画質を質問形式で取得
- 処理前に確認プロンプトを表示

### 2.3 コマンドライン引数モード
- 引数で直接設定を指定可能
- 自動化・スクリプト組み込みに対応

## 3. 使用方法

### 3.1 インタラクティブモード
```bash
npm run convert

# 実行時の質問例
? 入力フォルダのパス: ./images
? 出力フォルダのパス: ./output
? 画質 (0-100): 80
? 15枚の画像を変換します。よろしいですか？ (Y/n)
```

### 3.2 コマンドライン引数モード
```bash
# 基本的な使い方
npm run convert -- --input ./images --output ./output --quality 80

# 短縮形
npm run convert -- -i ./images -o ./output -q 80

# デフォルト値を使用（入力: ./input, 出力: ./output, 画質: 80）
npm run convert
```

## 4. コマンドライン引数仕様

| 引数 | 短縮形 | 説明 | デフォルト値 | 必須 |
|------|--------|------|-------------|------|
| --input | -i | 入力フォルダのパス | ./input | ❌ |
| --output | -o | 出力フォルダのパス | ./output | ❌ |
| --quality | -q | 画質 (0-100) | 80 | ❌ |
| --effort | -e | エンコード品質 (0-9) | 4 | ❌ |
| --resize | -r | リサイズ (例: 50%, 1920) | - | ❌ |
| --pattern | -p | ファイルパターン (glob) | *.{png,jpg,jpeg,webp} | ❌ |
| --yes | -y | 確認プロンプトをスキップ | false | ❌ |
| --silent | -s | 進捗表示を最小化 | false | ❌ |
| --help | -h | ヘルプを表示 | - | ❌ |
| --version | -v | バージョンを表示 | - | ❌ |

## 5. 画質パラメータ詳細

### 5.1 quality（画質）
- **範囲**: 0-100
- **推奨値**: 
  - 高品質（写真、ヒーロー画像）: 80-90
  - 標準品質（一般的な画像）: 70-80
  - 低品質（サムネイル）: 50-70
- **デフォルト**: 80

### 5.2 effort（エンコード品質）
- **範囲**: 0-9
- **説明**: 
  - 0: 最速（ファイルサイズ大）
  - 4: バランス型（推奨）
  - 9: 最高品質（処理時間長、ファイルサイズ小）
- **デフォルト**: 4

## 6. 出力仕様

### 6.1 ファイル名
- 元のファイル名を維持し、拡張子のみ `.avif` に変更
- 例: `hero-image.png` → `hero-image.avif`

### 6.2 出力フォルダ構造
- 入力フォルダのサブディレクトリ構造を維持
```
input/
  ├── top/
  │   └── hero.png
  └── common/
      └── logo.png

↓ 変換後

output/
  ├── top/
  │   └── hero.avif
  └── common/
      └── logo.avif
```

### 6.3 既存ファイルの扱い
- 変換処理開始時に出力フォルダはリセット（全削除）される
- 常にクリーンな状態で出力される

### 6.4 フォールバック画像
- AVIF変換と同時に、元のファイル形式（PNG/JPEG/WebP）での圧縮版も生成
- ファイル名は元のまま（例: `hero.png`）
- JPEG: mozjpegによる圧縮
- PNG: 減色処理（palette）と高圧縮
- WebP: 指定画質での圧縮

## 7. 進捗表示

### 7.1 通常モード
```bash
📁 15枚の画像を検出しました

🧹 出力フォルダをリセット中...

変換中...
[████████████████████] 100% | 15/15 | hero-image.png (1.2MB → 280KB)

✓ 完了！
  処理時間: 3.2秒
  元のサイズ: 12.5 MB
  AVIF変換後: 2.8 MB (77% 削減)
  圧縮版生成: 3.5 MB (72% 削減)
```

### 7.2 サイレントモード（--silent）
```bash
15/15 完了 (12.5MB → 2.8MB)
```

### 7.3 各ファイルの処理状況
- ファイル名
- 変換前のサイズ
- 変換後のサイズ
- 削減率

## 8. エラーハンドリング

### 8.1 想定されるエラー
- 入力フォルダが存在しない
- 出力フォルダの作成に失敗
- 画像ファイルの読み込みエラー
- 変換処理のエラー
- ディスク容量不足

### 8.2 エラー表示
```bash
❌ エラー: 入力フォルダが見つかりません
   パス: ./images

❌ 変換失敗: hero-image.png
   理由: ファイルが破損しています

⚠️  警告: 5枚中2枚の変換に失敗しました
```

### 8.3 処理継続
- 1枚の画像でエラーが発生しても、他の画像の処理は継続
- 最終的に成功・失敗の件数を表示

## 9. パフォーマンス要件

### 9.1 処理速度
- 並列処理を実装（CPUコア数に応じた並列数）
- 1枚あたりの目安処理時間: 0.2-1秒（画像サイズ・設定による）

### 9.2 メモリ使用量
- ストリーム処理により、大量の画像でもメモリ効率的に処理
- 目安: 同時に3-5枚程度をメモリに保持

### 9.3 画像枚数制限
- 制限なし
- 1000枚以上でも問題なく処理可能

## 10. 技術スタック

### 10.1 必須ライブラリ
- **sharp**: 画像変換エンジン（AVIF対応）
- **commander**: コマンドライン引数パース
- **inquirer**: インタラクティブプロンプト
- **cli-progress**: プログレスバー
- **chalk**: ターミナル文字色
- **glob**: ファイルパターンマッチ

### 10.2 開発環境
- Node.js: v16以上（AVIFサポートのため）
- npm または yarn

## 11. 設定ファイル（将来的な拡張）

優先度: 低（初期実装では不要）

### 11.1 設定ファイル形式
`avif-converter.config.js`
```javascript
module.exports = {
  input: './images',
  output: './output',
  quality: 80,
  effort: 4,
  // 個別ファイル設定
  overrides: {
    'hero-*.png': { quality: 90 },
    'thumbnail-*.png': { quality: 60 }
  }
}
```

## 12. 今後の拡張案（初期実装対象外）

### 12.1 追加機能候補
- [x] WebP/JPEGフォールバック画像の同時生成
- [ ] 設定ファイル対応
- [ ] ファイル名規則による個別画質設定
- [ ] リサイズ機能の拡充
- [ ] watch モード（フォルダ監視・自動変換）
- [ ] 変換結果のログファイル出力

### 12.2 Web UI版（別プロジェクト）
- ドラッグ&ドロップ対応
- プレビュー機能
- リアルタイム画質比較

## 13. テストケース

### 13.1 基本機能テスト
- [x] PNG画像の変換
- [x] JPEG画像の変換
- [x] 複数画像の一括変換
- [x] サブディレクトリ構造の維持
- [x] 画質設定の反映

### 13.2 エラーハンドリングテスト
- [x] 入力フォルダが存在しない場合
- [ ] 出力フォルダの作成失敗
- [x] 破損した画像ファイル
- [ ] 権限エラー

### 13.3 オプションテスト
- [x] 各コマンドライン引数の動作
- [x] デフォルト値の適用
- [x] インタラクティブモードの動作

## 14. ドキュメント

### 14.1 README.md
- インストール方法
- 使い方（例付き）
- オプション一覧
- トラブルシューティング

### 14.2 CHANGELOG.md
- バージョン履歴
- 変更内容

## 15. リリース計画

### v1.0.0（初期リリース）
- 基本的な変換機能
- インタラクティブモード
- コマンドライン引数モード
- 進捗表示
- エラーハンドリング

### v1.1.0（拡張版）
- リサイズ機能
- 設定ファイル対応
- パフォーマンス改善

### v2.0.0（高機能版）
- フォールバック画像生成
- watch モード
- 詳細なログ出力

---

## 付録A: 使用例

### ケース1: Figmaから書き出した画像を変換
```bash
# Figmaからexport → inputフォルダに配置
npm run convert -- -i ./input -o ./dist/images -q 85
```

### ケース2: サムネイル用に低画質変換
```bash
npm run convert -- -i ./thumbnails -o ./dist/thumbnails -q 60
```

### ケース3: ビルドスクリプトに組み込み
```json
// package.json
{
  "scripts": {
    "build:images": "node convert.js -i ./src/images -o ./dist/images -q 80 -y",
    "build": "npm run build:images && npm run build:app"
  }
}
```

## 付録B: Sharp AVIF設定リファレンス

```javascript
sharp(inputBuffer)
  .avif({
    quality: 80,      // 0-100
    effort: 4,        // 0-9
    chromaSubsampling: '4:4:4'  // 色のサブサンプリング
  })
  .toFile(outputPath);
```
